# Домашнее задание
## Работа с индексами, join'ами, статистикой

### Цель:
- знать и уметь применять основные виды индексов PostgreSQL
- строить и анализировать план выполнения запроса
- уметь оптимизировать запросы для с использованием индексов
- знать и уметь применять различные виды join'ов
- строить и анализировать план выполенения запроса
- оптимизировать запрос
- уметь собирать и анализировать статистику для таблицы

### Задание1 : Создать индексы на БД, которые ускорят доступ к данным.
#### В данном задании тренируются навыки:
- определения узких мест
- написания запросов для создания индекса 
- оптимизации 
#### Необходимо:
#### 1.1 Создать индекс к какой-либо из таблиц вашей БД
##### Результат:
- Пуст ь создана такая вот таблица (на 3000+- строк):
```
lesson15=# \d Personal
                                   Table "public.personal"
 Column |         Type          | Collation | Nullable |               Default
--------+-----------------------+-----------+----------+--------------------------------------
 id     | integer               |           | not null | nextval('personal_id_seq'::regclass)
 fio    | character varying(40) |           | not null |
 email  | character varying(20) |           |          |
 age    | integer               |           |          |
Check constraints:
    "personal_fio_check" CHECK (fio::text <> ''::text)

lesson15=# explain select fio from Personal where id <10;
                        QUERY PLAN
----------------------------------------------------------
 Seq Scan on personal  (cost=0.00..78.47 rows=7 width=53)
   Filter: (id < 10)
(2 rows)

```
сейчас индекса на таблице нет и планировщик будет использовать последовательный просмотр `Seq Scan`
- создадим индекс по полю id 
```
lesson15=# CREATE UNIQUE INDEX IF NOT EXISTS pk_Personal_idx ON Personal (id);
CREATE INDEX

```
- посмотрим тот же запрос через explain:
```
lesson15=# explain select fio from Personal where id <10;
                                   QUERY PLAN
---------------------------------------------------------------------------------
 Index Scan using pk_personal_idx on personal  (cost=0.28..8.43 rows=7 width=53)
   Index Cond: (id < 10)
(2 rows)

```
- теперь индекс есть он используется планировщиком, так как в условии where мы используем первое поле из индекса для отбора строк `Index Scan using` и это наш созданный индекс `pk_personal_idx`,
- но, если мы будем еще и выбирать поле из индекса, то планировщик будет использовать `Index Only Scan` :
```
lesson15=# explain select id from Personal where id <10;
                                     QUERY PLAN
-------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_idx on personal  (cost=0.28..4.40 rows=7 width=4)
   Index Cond: (id < 10)
(2 rows)

```
#### 1.2 Прислать текстом результат команды explain, в которой используется данный индекс
##### Результат:

```
lesson15=# explain select id from Personal where id <10;
                                     QUERY PLAN
-------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_idx on personal  (cost=0.28..4.40 rows=7 width=4)
   Index Cond: (id < 10)
(2 rows)

```
#### 1.3 Реализовать индекс для полнотекстового поиска
##### Результат:
- создадим еще одну таблицу
```
lesson15=# \d contracts
                                  Table "public.contracts"
    Column    |     Type      | Collation | Nullable |                Default
--------------+---------------+-----------+----------+---------------------------------------
 id           | integer       |           | not null | nextval('contracts_id_seq'::regclass)
 contracttype | contracttypes |           |          | 'Штатный сотрудник'::contracttypes
 contractkind | contractkinds |           |          | 'Основной'::contractkinds
 datestart    | date          |           | not null |
 dateend      | date          |           |          |
 bodytxt      | text          |           |          |
 bodyfidx     | tsvector      |           |          |
 monthcost    | numeric(10,2) |           |          |
 northcost    | numeric(2,0)  |           |          |
```
- заполнив её данными, построим индекс:
```
create index fts_contracts_bodyfidx_idx on Contracts using GIN (bodyfidx);
```
- проверим что он используется планировщиком:
```
lesson15=# explain select bodyfidx from Contracts where bodyfidx @@ to_tsquery('Багратион');
                                       QUERY PLAN
-----------------------------------------------------------------------------------------
 Bitmap Heap Scan on contracts  (cost=8.26..12.52 rows=1 width=84)
   Recheck Cond: (bodyfidx @@ to_tsquery('Багратион'::text))
   ->  Bitmap Index Scan on fts_contracts_bodyfidx_idx  (cost=0.00..8.26 rows=1 width=0)
         Index Cond: (bodyfidx @@ to_tsquery('Багратион'::text))
(4 rows)

```
- ну, получилось использовать индекс, (в явном не задавал "язык" при выборке, если здесь указать "язык" явно, то получим Sec scan).


#### 1.4 Реализовать индекс на часть таблицы или индекс на поле с функцией
##### Результат:
- мы знаем что у части записей в таблице не наполнено поле email, создадим для них индекс с условием:
```
lesson15=# CREATE INDEX IF NOT EXISTS pk_Personal_Null_email_idx ON Personal (Email) where Email is null;
CREATE INDEX
lesson15=# analyze personal;
ANALYZE
lesson15=# explain select email from Personal where Email is null;
                                           QUERY PLAN
-------------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_null_email_idx on personal  (cost=0.12..4.14 rows=1 width=16)
(1 row)
```
- если теперь выбрать только значение email по указанному, при создании индекса условию, то получим `Index Only Scan` 

- создадим "парный" к нему индекс:
```
lesson15=# CREATE INDEX IF NOT EXISTS pk_Personal_NotNull_email_idx ON Personal (Email) where Email is not null;
CREATE INDEX

lesson15=# explain select email from personal where (email is not null) and (email='emx6062st@second.com');
                                             QUERY PLAN
----------------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_notnull_email_idx on personal  (cost=0.28..4.30 rows=1 width=16)
   Index Cond: (email = 'emx6062st@second.com'::text)
(2 rows)


lesson15=# explain select email from personal where (email='emx6062st@second.com');
                                             QUERY PLAN
----------------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_notnull_email_idx on personal  (cost=0.28..4.30 rows=1 width=16)
   Index Cond: (email = 'emx6062st@second.com'::text)
(2 rows)


```
- в данном случае индекс работает так как выполняется условие указанное в индексе и поля выборки находятся в индексе

- Осталось создать индекс по функции (пусть это будет lower):
```
lesson15=# CREATE INDEX IF NOT EXISTS pk_Personal_lowerfio_idx ON Personal (lower(fio));
CREATE INDEX
lesson15=# analyze Personal;
ANALYZE
lesson15=# explain select fio from Personal where lower(fio)='иванов иван иванович';
                                        QUERY PLAN
------------------------------------------------------------------------------------------
 Index Scan using pk_personal_lowerfio_idx on personal  (cost=0.28..8.30 rows=1 width=53)
   Index Cond: (lower((fio)::text) = 'иванов иван иванович'::text)
(2 rows)
```
- индекс будет работать только если в условии запроса использована таже функция что и при построении индекса, что мы и сделали

#### 1.5 Создать индекс на несколько полей
##### Результат:
- построим индекс по полям Age и FIO:
```
lesson15=# CREATE INDEX IF NOT EXISTS pk_Personal_age_fio_idx ON Personal (age,fio);
CREATE INDEX
lesson15=# analyze personal;
ANALYZE
```
- индекс готов, посмотрим как и когда он используется планировщиком:
```
lesson15=# explain select age, fio from personal where age=46 and fio='Поликарпов Разумник Прохорович';
                                          QUERY PLAN
----------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_age_fio_idx on personal  (cost=0.28..4.30 rows=1 width=57)
   Index Cond: ((age = 46) AND (fio = 'Поликарпов Разумник Прохорович'::text))
(2 rows)
```
- поля выборки: age, fio условия идут в том же порядке что и поля в индексе `Index Only Scan using`

```
lesson15=# explain select age, fio from personal where age=46;
                                          QUERY PLAN
-----------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_age_fio_idx on personal  (cost=0.28..5.47 rows=68 width=57)
   Index Cond: (age = 46)
(2 rows)
```
- поля выборки:age, fio оставляем условие по первому полю в индексе и у нас опять `Index Only Scan using`

```
lesson15=# explain select age from personal where age=46;
                                          QUERY PLAN
----------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_age_fio_idx on personal  (cost=0.28..5.47 rows=68 width=4)
   Index Cond: (age = 46)
(2 rows)
```
- поля выборки:age оставляем условие по первому полю в индексе и у нас опять: `Index Only Scan using`


```
lesson15=# explain select fio, age from personal where age=46;
                                          QUERY PLAN
-----------------------------------------------------------------------------------------------
 Index Only Scan using pk_personal_age_fio_idx on personal  (cost=0.28..5.47 rows=68 width=57)
   Index Cond: (age = 46)
(2 rows)
```
- поля выборки: fio,age (поменяли местами) оставляем условие по первому полю в индексе и у нас опять `Index Only Scan using`

```
lesson15=# explain select * from personal where age=46;
                                      QUERY PLAN
---------------------------------------------------------------------------------------
 Bitmap Heap Scan on personal  (cost=4.81..47.91 rows=68 width=77)
   Recheck Cond: (age = 46)
   ->  Bitmap Index Scan on pk_personal_age_fio_idx  (cost=0.00..4.79 rows=68 width=0)
         Index Cond: (age = 46)
(4 rows)
```
- поля выборки: * оставляем условие по первому полю в индексе и вот и `Bitmap Heap Scan` все поля не входят в индекс, прийдется взять их из таблицы и так как сами строки можно "вычислить" по индексу, то планировщик задействует битовую карту

```
lesson15=# explain select * from personal where fio='Поликарпов Разумник Прохорович' and age=46;
                                       QUERY PLAN
-----------------------------------------------------------------------------------------
 Index Scan using pk_personal_age_fio_idx on personal  (cost=0.28..8.30 rows=1 width=77)
   Index Cond: ((age = 46) AND ((fio)::text = 'Поликарпов Разумник Прохорович'::text))
(2 rows)

```
- но если планировщик считает что может точно определить строку по индексу, то планирует Index Scan


```
lesson15=# explain select age,fio from personal where age>46;
                         QUERY PLAN
-------------------------------------------------------------
 Seq Scan on personal  (cost=0.00..78.47 rows=1267 width=57)
   Filter: (age > 46)
(2 rows)

```
- здесь планировщик считает, что не сможет определить операцию сравнения внутри индекса и поэтому предпочитает последовательное сканирование с дальнейшей фильтрацией


#### 1.6 Написать комментарии к каждому из индексов
Описать что и как делали и с какими проблемами столкнулись 
##### Результат:
Готово: см выше (комментарии идут под командой)

### Задание2 : В результате выполнения ДЗ вы научитесь пользоваться различными вариантами соединения таблиц. 
#### В данном задании тренируются навыки:
- написания запросов с различными типами соединений 
#### Необходимо:
#### 2.1 Реализовать прямое соединение двух или более таблиц
##### Результат:
- получим следующие сведения о сотрудниках id сотрудника в базе, его ФИО, название персональной позиции, тип рабочего места: 
```
select prs.id "перс-id", prs.fio "ФИО", pns.name "Позиция", pos.id "id позиции", pos.typeworkplace "Тип рабочего места" from positions pos inner join positionnames pns on pns.id=pos.positionnamesid inner join personaltopositions ptp on ptp.positionsid=pos.id inner join personal prs on prs.id=ptp.personalid;
```
-Часть результата:
```
 перс-id |                ФИО                 |      Позиция       | id позиции | Тип рабочего места
---------+------------------------------------+--------------------+------------+--------------------
      10 | Викторов Игнатий Софронович        | Старший аналитик   |         10 | Офис
      11 | Миронов Пётр Савелийович           | Старший специалист |         11 | Удаленка
      12 | Федотов Артемий Варфоломейович     | Бухгалтер          |         12 | Удаленка
      13 | Никитаов Николай Капитонович       | Старший специалист |         13 | Офис
      14 | Исидоров Фока Леонтийович          | Старший аналитик   |         14 | Микс
      15 | Магистрианов Платон Данактович     | Специалист         |         15 | Микс
      16 | Филатов Степан Силаович            | Эксперт            |         16 | Удаленка
      17 | Мартынов Зиновий Ростиславович     | Аналитик           |         17 | Удаленка
      18 | Савелийов Всеволод Викторович      | Старший специалист |         18 | Удаленка
      19 | Урбанов Венедикт Иудаович          | Ведущий эксперт    |         19 | Офис
      20 | Евстафийов Влас Добрыняович        | Эксперт            |         20 | Офис
      21 | Онисимов Демид Родославович        | Старший специалист |         21 | Удаленка
      22 | Прокопийов Аркадий Алексейович     | Ведущий эксперт    |         22 | Микс
      23 | Гордейов Геннадий Порфирийович     | Старший специалист |         23 | Удаленка
      24 | Логгинов Игнатий Никифорович       | Эксперт            |         24 | Офис
      25 | Герасимов Валентин Василийович     | Эксперт            |         25 | Удаленка
      26 | Даниилов Дмитрий Богданович        | Ведущий эксперт    |         26 | Удаленка
      27 | Максимов Варлам Лукийович          | Старший аналитик   |         27 | Офис
      28 | Данактов Кондрат Всеволодович      | Бухгалтер          |         28 | Офис
      29 | Агафонов Афанасий Никитаович       | Аналитик           |         29 | Удаленка
      30 | Германнов Владислав Егорович       | Эксперт            |         30 | Удаленка
      31 | Титов Платон Родославович          | Эксперт            |         31 | Удаленка
      32 | Прокопийов Корнилий Донатович      | Специалист         |         32 | Удаленка
      33 | Антонинов Вавила Александрович     | Старший аналитик   |         33 | Микс
      34 | Игорьов Акакий Геннадийович        | Старший специалист |         34 | Удаленка
      35 | Алексейов Германн Геласийович      | Старший специалист |         35 | Офис
      36 | Мартынов Валерий Вавилаович        | Ведущий эксперт    |         36 | Микс
      37 | Зиновийов Вадим Фомаович           | Ведущий эксперт    |         37 | Удаленка
      38 | Василийов Федот Павелович          | Эксперт            |         38 | Офис
      39 | Марков Кирилл Анфимович            | Ведущий эксперт    |         39 | Микс
      40 | Владленов Борис Иудаович           | Аналитик           |         40 | Удаленка
      41 | Иудаов Арсений Гавриилович         | Старший аналитик   |         41 | Микс
      42 | Кондратов Богдан Варламович        | Аналитик           |         42 | Удаленка
      43 | Вавилаов Тит Станиславович         | Старший специалист |         43 | Офис
      44 | Самуилов Спиридон Аркадийович      | Ведущий эксперт    |         44 | Удаленка
      45 | Евгенийов Станислав Даниилович     | Эксперт            |         45 | Удаленка
      46 | Агафонов Пров Савваович            | Эксперт            |         46 | Удаленка
      47 | Евсейов Протасий Родионович        | Бухгалтер          |         47 | Удаленка
      48 | Анатолийов Харитон Фролович        | Старший специалист |         48 | Удаленка
      49 | Евграфов Антонин Мстиславович      | Старший специалист |         49 | Удаленка
      50 | Никонов Егор Онисимович            | Старший специалист |         50 | Офис
      51 | Вячеславов Ерофей Кирович          | Старший специалист |         51 | Удаленка
***
     472 | Провов Владимир Созонович          | Аналитик           |        472 | Удаленка
     473 | Павелов Куприян Трофимович         | Старший специалист |        473 | Офис
     474 | Мирославов Лев Жданович            | Аналитик           |        474 | Удаленка
     475 | Фирсов Пров Дмитрийович            | Старший аналитик   |        475 | Удаленка
     476 | Трофимов Ким Матвейович            | Эксперт            |        476 | Удаленка
     477 | Тихонов Евсей Викентийович         | Старший специалист |        477 | Удаленка
     478 | Агапитов Пантелеймон Виссарионович | Эксперт            |        478 | Микс
     479 | Ефремов Агафон Миронович           | Эксперт            |        479 | Микс
     480 | Феликсов Леонид Фомаович           | Эксперт            |        480 | Удаленка
     481 | Демьянов Ефрем Валерьянович        | Эксперт            |        481 | Удаленка
     482 | Русланов Ждан Самуилович           | Ведущий эксперт    |        482 | Удаленка
     483 | Капитонов Гавриил Вадимович        | Ведущий эксперт    |        483 | Офис
     484 | Кононов Семён Максимович           | Аналитик           |        484 | Удаленка
     485 | Арсенийов Сергей Куприянович       | Ведущий эксперт    |        485 | Офис
     486 | Алексейов Спиридон Кириллович      | Старший аналитик   |        486 | Микс
     487 | Борисов Авксентий Тимофейович      | Аналитик           |        487 | Микс
     488 | Никодимов Анфим Геннадийович       | Аналитик           |        488 | Микс
(479 rows)

```
Данные выбираем прямым соединением из четырех таблиц:
- positionnames - справочник наименований позиций - берем человекочитаемое название позиции (pns.name "Позиция")
- positions - таблица позиций сотрудников - берем (pos.id "id позиции", pos.typeworkplace "Тип рабочего места")
- personaltopositions - связь персонала (сотрудников) с позициями (содержит дату привязки сотрудника к позиции, но они нам сейчас не нужны)
- personal - таблица персонала (сотрудников) - берем prs.id "перс-id", prs.fio "ФИО"

#### 2.2 Реализовать левостороннее (или правостороннее) соединение двух или более таблиц
##### Результат:
- Посмотрим теперь в каких отделах есть "позиции" для сотрудников, (так как возможна ситуация при которой к подразделению не привязаны позиции, то чтобы не "потерять" такие подразделения используем левосторонне соединение)
```
select hl.name "Отдел", pth.positionsid "Ид позиции", pth.datein "Дата открытия позиции" from hierarchylist hl left join positionstohierarchy pth on pth.hierarchyid=hl.id;
```
- Часть результатов:
```
                  Отдел                   | Ид позиции | Дата открытия позиции
------------------------------------------+------------+-----------------------
 Отдел бизнес аналитики                   |         10 | 2021-11-23
 Отдел продаж                             |         11 | 2021-11-23
 Сектор внешних платежей                  |         12 | 2021-11-23
 Отдел продаж                             |         13 | 2021-11-23
 Отдел ИТ аналитики                       |         14 | 2021-11-23
 Отдел продаж                             |         15 | 2021-11-23
 Отдел разработки                         |         16 | 2021-11-23
 Отдел бизнес аналитики                   |         17 | 2021-11-23
 Отдел продаж                             |         18 | 2021-11-23
 Отдел разработки                         |         19 | 2021-11-23
 Отдел тестирования                       |         20 | 2021-11-23
 Отдел продаж                             |         21 | 2021-11-23
 Отдел тестирования                       |         22 | 2021-11-23
 Отдел продаж                             |         23 | 2021-11-23
 Сектор поддержки сотрудников организации |         24 | 2021-11-23
 Отдел тестирования                       |         25 | 2021-11-23
 Отдел тестирования                       |         26 | 2021-11-23
 Отдел ИТ аналитики                       |         27 | 2021-11-23
 Сектор внешних платежей                  |         28 | 2021-11-23
 Отдел ИТ аналитики                       |         29 | 2021-11-23
 Отдел тестирования                       |         30 | 2021-11-23
 Отдел тестирования                       |         31 | 2021-11-23
 Отдел продаж                             |         32 | 2021-11-23
 Отдел бизнес аналитики                   |         33 | 2021-11-23
 Отдел продаж                             |         34 | 2021-11-23
 Отдел продаж                             |         35 | 2021-11-23
 Отдел тестирования                       |         36 | 2021-11-27
 Отдел тестирования                       |         37 | 2018-08-05
 Отдел тестирования                       |         38 | 2021-05-13
 Отдел тестирования                       |         39 | 2017-11-14
 Отдел ИТ аналитики                       |         40 | 2020-09-24
 Отдел бизнес аналитики                   |         41 | 2018-10-15
 Отдел ИТ аналитики                       |         42 | 2020-05-29
 Отдел продаж                             |         43 | 2021-07-16
 Отдел тестирования                       |         44 | 2021-04-14
***
 Отдел продаж                             |        473 | 2020-09-25
 Отдел ИТ аналитики                       |        474 | 2018-04-09
 Отдел бизнес аналитики                   |        475 | 2018-11-06
 Отдел тестирования                       |        476 | 2021-07-08
 Отдел продаж                             |        477 | 2017-07-08
 Отдел тестирования                       |        478 | 2020-12-29
 Отдел поддержки                          |            |
 Отдел кадров                             |            |
 Сектор поддержки клиентов организации    |            |
 ИТ                                       |            |
 Руководство                              |            |
 my organisation                          |            |
 Бухгалтерия                              |            |
(476 rows)
```
- как видим: Отдел поддержки, ...,  Бухгалтерия  действительно не имеют привязанных позиций! 
- hierarchylist - таблица структуры организации
- positionstohierarchy - таблица связи структурных подразделений с "позициями"

#### 2.3 Реализовать кросс соединение двух или более таблиц
##### Результат:
- попробуем ответить на вопрос: "а что было бы если бы в каждом узле структуры организации были бы абсолютно все возможные для этой организации наименования позиций? как нам получить и вывестивывести их на экран?"
```
select * from positionnames posn cross join hierarchylist hl;
```
- cross join служит для выборки по типу декартова произведения множеств, поэтому получается что-то в этом роде:
```
 id |           name           | id | parentid |                   name
----+--------------------------+----+----------+------------------------------------------
  1 | Специалист               |  1 |          | my organisation
  1 | Специалист               |  2 |        1 | Отдел кадров
  1 | Специалист               |  3 |        1 | Бухгалтерия
  1 | Специалист               |  4 |        1 | Отдел продаж
  1 | Специалист               |  5 |        1 | ИТ
  1 | Специалист               |  6 |        1 | Руководство
  1 | Специалист               |  8 |        2 | Сектор внешних платежей
  1 | Специалист               |  7 |        2 | Сектор начисления зарплат
  1 | Специалист               |  9 |        5 | Отдел разработки
  1 | Специалист               | 10 |        5 | Отдел тестирования
  1 | Специалист               | 11 |        5 | Отдел поддержки
  1 | Специалист               | 12 |       11 | Сектор поддержки сотрудников организации
  1 | Специалист               | 13 |       11 | Сектор поддержки клиентов организации
  1 | Специалист               | 14 |        5 | Отдел ИТ аналитики
  1 | Специалист               | 15 |        6 | Отдел бизнес аналитики
  2 | Старший специалист       |  1 |          | my organisation
  2 | Старший специалист       |  2 |        1 | Отдел кадров
  2 | Старший специалист       |  3 |        1 | Бухгалтерия
  2 | Старший специалист       |  4 |        1 | Отдел продаж
  2 | Старший специалист       |  5 |        1 | ИТ
  2 | Старший специалист       |  6 |        1 | Руководство
  2 | Старший специалист       |  8 |        2 | Сектор внешних платежей
  2 | Старший специалист       |  7 |        2 | Сектор начисления зарплат
  2 | Старший специалист       |  9 |        5 | Отдел разработки
  2 | Старший специалист       | 10 |        5 | Отдел тестирования
  2 | Старший специалист       | 11 |        5 | Отдел поддержки
  2 | Старший специалист       | 12 |       11 | Сектор поддержки сотрудников организации
  2 | Старший специалист       | 13 |       11 | Сектор поддержки клиентов организации
  2 | Старший специалист       | 14 |        5 | Отдел ИТ аналитики
  2 | Старший специалист       | 15 |        6 | Отдел бизнес аналитики
  3 | Эксперт                  |  1 |          | my organisation
  3 | Эксперт                  |  2 |        1 | Отдел кадров
  3 | Эксперт                  |  3 |        1 | Бухгалтерия
  3 | Эксперт                  |  4 |        1 | Отдел продаж
  3 | Эксперт                  |  5 |        1 | ИТ
  3 | Эксперт                  |  6 |        1 | Руководство
  3 | Эксперт                  |  8 |        2 | Сектор внешних платежей
  3 | Эксперт                  |  7 |        2 | Сектор начисления зарплат
  3 | Эксперт                  |  9 |        5 | Отдел разработки
  3 | Эксперт                  | 10 |        5 | Отдел тестирования
  3 | Эксперт                  | 11 |        5 | Отдел поддержки
  3 | Эксперт                  | 12 |       11 | Сектор поддержки сотрудников организации
  3 | Эксперт                  | 13 |       11 | Сектор поддержки клиентов организации
  3 | Эксперт                  | 14 |        5 | Отдел ИТ аналитики
  3 | Эксперт                  | 15 |        6 | Отдел бизнес аналитики
  4 | Ведущий эксперт          |  1 |          | my organisation
***
 12 | Лидер трайба             | 15 |        6 | Отдел бизнес аналитики
 13 | Технический лидер трайба |  1 |          | my organisation
 13 | Технический лидер трайба |  2 |        1 | Отдел кадров
 13 | Технический лидер трайба |  3 |        1 | Бухгалтерия
 13 | Технический лидер трайба |  4 |        1 | Отдел продаж
 13 | Технический лидер трайба |  5 |        1 | ИТ
 13 | Технический лидер трайба |  6 |        1 | Руководство
 13 | Технический лидер трайба |  8 |        2 | Сектор внешних платежей
 13 | Технический лидер трайба |  7 |        2 | Сектор начисления зарплат
 13 | Технический лидер трайба |  9 |        5 | Отдел разработки
 13 | Технический лидер трайба | 10 |        5 | Отдел тестирования
 13 | Технический лидер трайба | 11 |        5 | Отдел поддержки
 13 | Технический лидер трайба | 12 |       11 | Сектор поддержки сотрудников организации
 13 | Технический лидер трайба | 13 |       11 | Сектор поддержки клиентов организации
 13 | Технический лидер трайба | 14 |        5 | Отдел ИТ аналитики
 13 | Технический лидер трайба | 15 |        6 | Отдел бизнес аналитики
(195 rows)

```
- проверим как там все ли сходится?
```
lesson15=# select count(*) from hierarchylist;
 count
-------
    15
(1 row)

lesson15=# select count(*) from positionnames;
 count
-------
    13
(1 row)

lesson15=# select 15*13;
 ?column?
----------
      195
(1 row)

```
- ну точно оно :)


#### 2.4 Реализовать полное соединение двух или более таблиц
##### Результат:
- предположим что мы решили просмотреть все ли сотрудники привязаны к позициям и все ли позиции заняты сотрудниками одновременно:
```
select prs.fio "ФИО", prs.id "ИД сотрудника", ptp.personalid "ИД сотрудника в таблице связи", ptp.positionsid "Ид позиции в таблице связи", pos.id "ИД позиции" from personal prs full outer join personaltopositions ptp on ptp.personalid=prs.id full outer join positions pos on pos.id=ptp.positionsid;
```
- посмотрим на результат:
```
                  ФИО                  | ИД сотрудника | ИД сотрудника в таблице связи | Ид позиции в таблице связи | ИД позиции
---------------------------------------+---------------+-------------------------------+----------------------------+------------
 Аркадийов Лаврентий Иннокентийович    |             3 |                               |                            |
 Архиппов Варфоломей Даниилович        |             5 |                               |                            |
 Святославов Климент Савелийович       |             6 |                               |                            |
 Поликарпов Разумник Прохорович        |             7 |                               |                            |
 Лукийов Владимир Протасийович         |             8 |                               |                            |
 Аркадийов Фрол Софронович             |             9 |                               |                            |
 Викторов Игнатий Софронович           |            10 |                            10 |                         10 |         10
 Миронов Пётр Савелийович              |            11 |                            11 |                         11 |         11
 Федотов Артемий Варфоломейович        |            12 |                            12 |                         12 |         12
 Никитаов Николай Капитонович          |            13 |                            13 |                         13 |         13
 Исидоров Фока Леонтийович             |            14 |                            14 |                         14 |         14
 Магистрианов Платон Данактович        |            15 |                            15 |                         15 |         15
 Филатов Степан Силаович               |            16 |                            16 |                         16 |         16
 Мартынов Зиновий Ростиславович        |            17 |                            17 |                         17 |         17
 Савелийов Всеволод Викторович         |            18 |                            18 |                         18 |         18
 Урбанов Венедикт Иудаович             |            19 |                            19 |                         19 |         19
 Евстафийов Влас Добрыняович           |            20 |                            20 |                         20 |         20
 Онисимов Демид Родославович           |            21 |                            21 |                         21 |         21
 Прокопийов Аркадий Алексейович        |            22 |                            22 |                         22 |         22
***
 Арсенийов Сергей Куприянович          |           485 |                           485 |                        485 |        485
 Алексейов Спиридон Кириллович         |           486 |                           486 |                        486 |        486
 Борисов Авксентий Тимофейович         |           487 |                           487 |                        487 |        487
 Никодимов Анфим Геннадийович          |           488 |                           488 |                        488 |        488
 Ильяов Вадим Богданович               |           489 |                               |                            |
 Парфенийов Евграф Владиславович       |           490 |                               |                            |
***
 Мелентийов Лаврентий Вениаминович     |          2993 |                               |                            |
 Митрофанов Денис Александрович        |          2994 |                               |                            |
 Игорьов Климент Станиславович         |          2995 |                               |                            |
 Фомаов Георгий Авдейович              |          2996 |                               |                            |
 Тихонов Максим Артемийович            |          2997 |                               |                            |
 Авдейов Трофим Мирославович           |          2998 |                               |                            |
 Варсонофийов Платон Аристархович      |          2999 |                               |                            |
 Еремейов Всеволод Пахомийович         |          3000 |                               |                            |
 Анфимов Игнатий Авдейович             |          3001 |                               |                            |
                                       |               |                               |                            |        497
                                       |               |                               |                            |        496
                                       |               |                               |                            |        489
                                       |               |                               |                            |          2
                                       |               |                               |                            |          5
                                       |               |                               |                            |        499
                                       |               |                               |                            |        498
                                       |               |                               |                            |        493
                                       |               |                               |                            |        492
                                       |               |                               |                            |        494
                                       |               |                               |                            |          8
                                       |               |                               |                            |          6
                                       |               |                               |                            |          4
                                       |               |                               |                            |          1
                                       |               |                               |                            |        495
                                       |               |                               |                            |          3
                                       |               |                               |                            |        491
                                       |               |                               |                            |        490
                                       |               |                               |                            |          9
                                       |               |                               |                            |          7
(3018 rows)

```
- хм, выходит что у нас в таблице персонала есть записи с id<10 и с id >488 не привязанные к позициям (это не нормально), но для тестовой базы пойдет :)
- и позиции с id <10 и id>488 не привязанные к сотрудникам (вакантные) это нормально


#### 2.5 Реализовать запрос, в котором будут использованы разные типы соединений
##### Результат:
- теперь посмотрим все позиции в привязке к сотрудникам, при этом выведем не только ИД но и человекочитаемое имя позиции, Нам также интересно какие позиции сейчас вакантны и на которых никогда никто не работал:
```
select prs.fio "ФИО", prs.id "ИД сотрудника", pos.id "ИД позиции",pns.name "Наименование позиции" from personal prs inner join personaltopositions ptp on ptp.personalid=prs.id right join positions pos on pos.id=ptp.positionsid inner join positionnames pns on pns.id=pos.positionnamesid;
```
- посмотрим не результаты:
```
                ФИО                 | ИД сотрудника | ИД позиции | Наименование позиции
------------------------------------+---------------+------------+----------------------
 Викторов Игнатий Софронович        |            10 |         10 | Старший аналитик
 Миронов Пётр Савелийович           |            11 |         11 | Старший специалист
 Федотов Артемий Варфоломейович     |            12 |         12 | Бухгалтер
 Никитаов Николай Капитонович       |            13 |         13 | Старший специалист
 Исидоров Фока Леонтийович          |            14 |         14 | Старший аналитик
 Магистрианов Платон Данактович     |            15 |         15 | Специалист
 Филатов Степан Силаович            |            16 |         16 | Эксперт
 Мартынов Зиновий Ростиславович     |            17 |         17 | Аналитик
 Савелийов Всеволод Викторович      |            18 |         18 | Старший специалист
 Урбанов Венедикт Иудаович          |            19 |         19 | Ведущий эксперт
 Евстафийов Влас Добрыняович        |            20 |         20 | Эксперт
 Онисимов Демид Родославович        |            21 |         21 | Старший специалист
 Прокопийов Аркадий Алексейович     |            22 |         22 | Ведущий эксперт
 Гордейов Геннадий Порфирийович     |            23 |         23 | Старший специалист
 Логгинов Игнатий Никифорович       |            24 |         24 | Эксперт
 Герасимов Валентин Василийович     |            25 |         25 | Эксперт
 Даниилов Дмитрий Богданович        |            26 |         26 | Ведущий эксперт
 Максимов Варлам Лукийович          |            27 |         27 | Старший аналитик
 Данактов Кондрат Всеволодович      |            28 |         28 | Бухгалтер
 Агафонов Афанасий Никитаович       |            29 |         29 | Аналитик
 Германнов Владислав Егорович       |            30 |         30 | Эксперт
***
 Алексейов Спиридон Кириллович      |           486 |        486 | Старший аналитик
 Борисов Авксентий Тимофейович      |           487 |        487 | Аналитик
 Никодимов Анфим Геннадийович       |           488 |        488 | Аналитик
                                    |               |        497 | Аналитик
                                    |               |        496 | Старший специалист
                                    |               |        489 | Специалист
                                    |               |          2 | Старший аналитик
                                    |               |          5 | Старший специалист
                                    |               |        499 | Аналитик
                                    |               |        498 | Эксперт
                                    |               |        493 | Аналитик
                                    |               |        492 | Старший специалист
                                    |               |        494 | Старший специалист
                                    |               |          8 | Ведущий эксперт
                                    |               |          6 | Старший специалист
                                    |               |          4 | Старший аналитик
                                    |               |          1 | Аналитик
                                    |               |        495 | Старший аналитик
                                    |               |          3 | Старший аналитик
                                    |               |        491 | Старший аналитик
                                    |               |        490 | Старший аналитик
                                    |               |          9 | Специалист
                                    |               |          7 | Аналитик
(499 rows)

```
- теперь мы знаем, что в организации идет поиск сотрудников на должности приблизительно 20 новых позиций! (раз нет соответствия значит они новые иначе были бы записи с закрытыми датами, но для данных должностных позиций их нет)
- здесь использовано 2 прямых (inner) и одно правостороннее (right) соединения. Первые дали нам точные совпадения для наименований должностей с позициями, а также связь сотрудников с позициями только для тех сотрудников у которых такая связь существует, а right join дал нам возможность получить в добавок те позиции, для которых нет привязки к сотрудникам (те самые новые должностные позиции)
pos.id=ptp.positionsid

#### 2.6 Сделать комментарии на каждый запрос
##### Результат:
Готово

#### 2.7 К работе приложить структуру таблиц, для которых выполнялись соединения
##### Результат:
```
CREATE TYPE ContractTypes AS ENUM ('Штатный сотрудник', 'Совместитель', 'Внешний сотрудник', 'Хоз договор');
CREATE TYPE ContractKinds AS ENUM ('Основной', 'Доп соглашение');
CREATE TYPE WorkPlaceTypes AS ENUM ('Офис', 'Удаленка', 'Микс');

-- Сотрудники
CREATE TABLE Personal (
	Id serial,
	FIO varchar(40) NOT NULL CHECK (FIO <> ''),
	Email varchar(20),
	Age integer
);

--Справочник наименований должностных позиций
CREATE TABLE PositionNames (
	Id serial,
	Name varchar(40) NOT NULL CHECK (Name <> '')
);

-- должностные позиции
CREATE TABLE Positions (
	Id serial, 
	PositionNamesId integer,
	LimitMonthCost NUMERIC(10, 2), 
	LimitMonthExtra NUMERIC(10, 2), 
 	LimitYear NUMERIC(10, 2), 
	TypeWorkPlace WorkPlaceTypes default 'Офис'
);

-- структура подразделений
CREATE TABLE HierarchyList (
	Id serial,
	ParentId integer, 
	Name varchar(40) NOT NULL CHECK (Name <> '')
);

-- привязка позиций к структуре подразделений 
CREATE TABLE PositionsToHierarchy (
	Id serial,
	HierarchyId integer not null, 
	PositionsId integer not null, 
	DateIn date not null,                 -- дата открытия позиции в подразделении
	DateOut date                          -- дата закрытия позиции в подразделении
);

-- привязка персонала (сотрудников) к позициям
CREATE TABLE PersonalToPositions (
	Id serial,
	PersonalId integer not null,
	PositionsId integer not null,
	DateIn date not null,                 -- дата принятия сотрудника на позицию (фактическая)
	DateOut date                          -- дата увольнения сотрудника с позиции (фактическая)
);

-- договоры с сотрудниками 
CREATE TABLE Contracts (
	Id serial, 
	ContractType ContractTypes default 'Штатный сотрудник', -- тип сотрудника/договора с ним
	ContractKind ContractKinds default 'Основной',          -- подтип договора
	DateStart date not null,                                -- дата заключения
	DateEnd date,                                           -- дата окончания (для срочных договоров)
	BodyTxt text,                                           -- текст договора
	BodyFIDX tsvector,                                      -- поле для облегчения поиска по тексту договора
	MonthCost NUMERIC(10, 2),                               -- Сума договора в месяц
	NorthCost NUMERIC(2)                                    -- Северный коэффициент
);

-- привязка персонала (сотрудников) и договоров
CREATE TABLE PersonalToContracts (
	Id serial,
	PersonalId integer not null,
	ContractsId integer not null,
	DateIn date,				-- Дата фактического начала работы по договору (используется если договор расторгнут досрочно)
	DateOut date                            -- Дата фактического расторжения договора (используется если договор расторгнут досрочно)
);

```
#### 2.8 Придумайте 3 своих метрики на основе показанных представлений, отправьте их через ЛК, а так же поделитесь с коллегами в слаке
##### Результат: 

- Количество обслуживающих процессов, в настоящее время подключённых к этой базе данных мониторим количество смотрим на резкое незапланированное изменение или приближение к максимуму
```
lesson15=# select numbackends from pg_stat_database where datname='lesson15';
 numbackends
-------------
           1
(1 row)

```

- получить id  самых "долгих" запросов для анализа
```
lesson15=# select queryid,max_exec_time from pg_stat_statements order by max_exec_time desc limit 5;
       queryid        |   max_exec_time
----------------------+--------------------
 -6779979322859524240 |          11.699602
    24870722077944205 |          11.276612
  6322269003077889846 |          11.031549
  -403249069933831273 |          11.018048
  -384365293937896840 | 10.694431000000002
(5 rows)

```

- Ищем подозрительно долгие запросы которые сейчас выполняются в базе время меняем в зависимости от наших потребностей (сейчас 5 минут сначала запроса и 4 минуты с последнего изменения состояния запроса)
```
select pid from pg_stat_activity where (query_start +(('00:05:00')::interval))<now() and backend_type='client backend' and (xact_start is not null) and ((state_change +(('00:04:00')::interval))<now());
 pid
-----
(0 rows)
```

- мониторить активность процессов на БД, сверять текущую выборку с предыдущей реагировать на увеличение, требует доп обработки после выборки для сравнения значений
```
select * from pg_stat_activity where (datname='lesson15') and (xact_start is not null) and (wait_event_type is not null) and (state in ('idle in transaction','idle in transaction (aborted)'))\gx
```
